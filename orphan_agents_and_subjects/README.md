# Orphan Subject and Agent Records
Last updated on 11/11/2024 by Kylene Hutchinson.

| Start Date | End Date   | Contributors      | Informed Stakeholders |
| ---------- | ---------- | ----------------- | --------------------- |
| 10/28/2024 | 11/11/2024 | Kylene Hutchinson | Alicia Detelich       |
# Overview
## Problem Statement
ArchivesSpace has a number of Agent and Subject records that are no longer linked to any Resource, Archival, or Digital Object. These unlinked records cause issues with LUX and require cleanup.
## Goals
- Identify all agent and subject records which are not linked to a resource or archival object record
-  Delete these agents and subjects
# Background
Agent and Subject records become unlinked when a resource or object is updated or removed. Unfortunately the web client inaccurately will display these records as still linked, but the API and SQL will accurately reflect the true linking status.

# Process
See [orphan_agentsubject.py](orphan_agentsubject.py) and [241108_update.csv](241108_update.csv)
- Write a SQL Query that gathers URIs of Subjects, People Agents, Corpo Agents, Software Agents, and Family Agents that are not linked to anything. Restrict People Agents who are payment authorizers or users in ArchivesSpace; restrict Corpo Agents that represent repositories in ArchivesSpace; restrict the Software Agent for ArchivesSpace.
- Create Backups of Agent and Subject Records on your local device
- Delete the Agent or Subject Records via API
- Record Deletes and Errors in a csv.
# Notes

| Date       | Highlight  | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ---------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 10/24/2024 | Review     | Asked a few questions about this project, among a few others. Alicia revealed some information about the web client and background for this project.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 10/28/2024 | Testing    | Wrote code that grabbed unlinked agents and orphans, then deleted them. Tested in Test. API is SO SLOW.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 11/01/2024 | Meeting    | Spoke with Alicia about which ids needed to be included in the list.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 11/05/2024 | Testing    | Tested in Test, was able to update the SQL query to return only unlinked agents and subjects after speaking further with Alicia to better understand the agent tables.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 11/06/2024 | Testing    | New Query returned only unlinked agents and subjects. Ran on a couple hundred records in Test and everything deleted cleanly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 11/07/2024 | Meeting    | Alicia approved running the code in production, especially after we discovered ArchivesSpace will not allow us to delete agents via the API if they are linked. It will return a 409 code.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 11/08/2024 | Production | Ran in Production. Found 1454 records, 10 of which were not deleted. 3 were corporate agents that the API reported as linked, and 7 returned 409 errors. 2 of the 409s were people agents linked to the payment_authorizer_rlshp table so adding that in to the SQL removed those. The 5 409 corpo agents were agents for the repos that were being grabbed for some reason; making an update to how that table was joined fixed this. The 3 corpos marked as linked were the same uri 3 times, which strangely appear in the linked_agent_rlshp table with 3 lines not linked to anything, but it did have other lines linked to other resources. Not sure what causes those 3 unlinked rows in the table, but I just adjusted the SQL to ignore anything that appears in the linked_agent_rlshp table since Alicia confirmed anything in that table should not be deleted. |
| 11/11/2024 | Completed  | Everything else was deleted cleanly and the 10 not deleted were confirmed to be entries that shouldn't be deleted. I updated the SQL query so it will properly exclude those agents in the future.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

# Review

## Data Details
- 1,453
	- 578 people agents
	- 6 family agents
	- 305 corpo agents
	- 0 software agents
	- 562 subjects
## Communication
| Name            | Position                                                                                           | Notes                                   |
| --------------- | -------------------------------------------------------------------------------------------------- | --------------------------------------- |
| Alicia Detelich | Assistant Director of Special Collection Metadata Services, Special Collections Technical Services | - Explained Agents and agent SQL tables |
## Results
1,444 of 1,454 records found by the SQL query were deleted in production. Reviewing the 10 that weren't deleted found some small flaws in the query that have since been updated. Code should work fine for future deletes, especially since ArchivesSpace will refuse to delete any agent that is linked to something.

# References

- [Github Issue - Delete orphan subject and agent records (LUX)](https://github.com/orgs/Yale-DMAC/projects/1/views/1?pane=issue&itemId=25333681)